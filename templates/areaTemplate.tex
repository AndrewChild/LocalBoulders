%# ---------------------------------
%# ------------Macros---------------
%# ---------------------------------
%#
%% macro resolve_images(item, loc='b')
%% for im in item.images
%% if im.loc == loc
\VAR{image(im.path_o+im.outFileName, im.description, im.size)}\label{\VAR{im.ref}:\VAR{im.name}}
%% endif
%% endfor
%% endmacro
%#
%% macro resolve_images_area_head(item, loc='b', size='f')
%# --- this is sort of a hacky work around that prevents the template from starting and ending multicols immediately 
%# --- if an area starts with a full width photo
%% for im in item.image
%% if im.loc == loc
%% if im.size == size
\VAR{image(im.path_o+im.outFileName, im.description, size='h')}\label{\VAR{im.ref}:\VAR{im.name}}
%% endif
%% endif
%% endfor
%% endmacro
%#
%% macro image(filePath, description=None, size='h')
%% if size == 'f' or size == 'h'
	%% if size == 'f'
	\end{multicols}
	%% endif
	\setbox0=\hbox{\begin{overpic}[width=0.8\linewidth]{\VAR{filePath}}\VAR{caption1(description)}
	\end{overpic}}
	\needspace{\ht0}
	\begin{center}
	\begin{overpic}[width=0.9\linewidth]{\VAR{filePath}}\VAR{caption1(description)}
	\end{overpic}
	\end{center}
	%% if size == 'f'
	\raggedcolumns
	\begin{multicols}{2}
	%% endif
%% elif size == 'p'
	\includepdf[\VAR{caption2(description)}]{\VAR{filePath}}
%% elif size == 's'
	\cleardoublepage
	\includepdf[pages=-, \VAR{caption2(description)}]{\VAR{filePath}}
%% endif
%% endmacro
%#
%% macro caption1(description)
%% if description
\put (0,5) {\colorbox{\chapterColor}{\parbox{0.8\linewidth}{\textcolor{white}{\VAR{description}}}}}
%% endif
%% endmacro
%#
%% macro caption2(description)
%% if description
picturecommand*={\put (10,10) {\colorbox{\chapterColor}{\parbox{0.6\paperwidth}{\textcolor{white}{\VAR{description}}}}}}
%% endif
%% endmacro
%#
%% macro climbLabel(climb)
\needspace{1.5cm}
\label{\VAR{climb.ref}:\VAR{climb.name}}
\colorbox{\VAR{climb.color_LaTeX}}{
\parbox{0.95\linewidth}{
\textbf{
\VAR{climb.getRtNum()} \VAR{climb.name}\VAR{climb.name_unconfirmed_LaTeX} \VAR{climb.grade_str}\VAR{climb.grade_unconfirmed_LaTeX} \VAR{climb.rating_LaTeX} \VAR{climb.serious_LaTeX}
}}}
%% endmacro
%#
%% macro description(description)
%% if description != ''
\VAR{description}\\
%% endif
%% endmacro
%#
%# ---------------------------------
%# ------------Body-----------------
%# ---------------------------------
%#
\formatChapter{\VAR{area.name}}
\VAR{resolve_images_area_head(area, size='f')}
\raggedcolumns
\begin{multicols}{2}
\VAR{resolve_images_area_head(area, size='h')}
%% if area.gps
\qrcode{\VAR{area.paths['qr_o']}/\VAR{area.name}_qr.png}{http://maps.google.com/maps?q=\VAR{area.gps}}{Navigate to this area}
%% endif
\includegraphics[width=0.9\linewidth]{\VAR{area.paths['histogram_o']}/\VAR{area.name}.png}
\end{multicols}
\begin{multicols}{2}
\VAR{description(area.description)}
%% if area.incomplete
\textbf{NOTE: This area is mostly incomplete. Look forward to more information in future revisions of this book or contribute your own knowledge on github.}\\
%% endif
\VAR{resolve_images(area, 'a')}

%% for subArea in area.subareas.values()
\newpage
\VAR{resolve_images(subArea)}
%% if subArea.name
\section{\VAR{subArea.getSubAreaLtr()} - \VAR{subArea.name}}\label{sa:\VAR{subArea.name}}
%% endif
%% if subArea.gps
\qrcode{\VAR{area.paths['qr_o']}\VAR{subArea.name}_qr.png}{http://maps.google.com/maps?q=\VAR{subArea.gps}}{Navigate to this sub area}
%% endif
\VAR{description(subArea.description)}
\VAR{resolve_images(subArea, 'a')}

%% for formation in subArea.formations.values()
\VAR{resolve_images(formation)}
\needspace{1.5cm}
\subsection*{\VAR{formation.name}}\label{bf:\VAR{formation.name}}
\VAR{description(formation.description)}	
\VAR{resolve_images(formation, 'a')}
%% for route in formation.routes.values()
\VAR{resolve_images(route)}
\VAR{climbLabel(route)}
\begin{adjustwidth}{0.5cm}{}			
\VAR{route.description}\VAR{' (No Topo)' if not route.hasTopo}
\end{adjustwidth}
\VAR{resolve_images(route, 'a')}
%% if route.variations.values()
\begin{adjustwidth}{0.5cm}{}				
\needspace{3cm}
\textbf{Variations:} \newline
%% for variation in route.variations.values()
\VAR{resolve_images(variation)}
\VAR{climbLabel(variation)}
\begin{adjustwidth}{0.5cm}{}			
\VAR{variation.description}\VAR{' (No Topo)' if not variation.hasTopo}
\end{adjustwidth}
\VAR{resolve_images(variation, 'a')}
\VAR{resolve_images(variation, 'e')}
%% endfor
\end{adjustwidth}
%% endif
\VAR{resolve_images(route, 'e')}
%% endfor 
\VAR{resolve_images(formation, 'e')}
%% endfor 
\VAR{resolve_images(subArea, 'e')}
%% endfor
\VAR{resolve_images(area, 'e')}
\end{multicols}
\clearpage