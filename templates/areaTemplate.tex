%# ---------------------------------
%# ------------Macros---------------
%# ---------------------------------
%#
%#
%# --- loops through all images attached to item and checks to see if they should be placed here
%% macro resolve_images(item, loc='b')
%% for im in item.images
%% if im.loc == loc
\VAR{image(im, im.size)}
%% endif
%% endfor
%% endmacro
%#
%#
%# --- this is sort of a hacky work around that prevents the template from starting and ending multicols immediately 
%# --- if an area starts with a full width photo
%% macro resolve_images_area_head(item, loc='b', size='f')
%% if size == 'f' or size == 'h'
%% for im in item.images
%% if im.loc == loc and im.size == size
\VAR{image(im, size='h')}
%% endif
%% endfor
%% else
%% for im in item.images
%% if im.loc == loc and im.size == size
\VAR{image(im, im.size)}
%% endif
%% endfor
%% endif
%% endmacro
%#
%#
%# --- Handles image placement. 
%# --- Skips placement of action photos if "skip_action_photos" format option is entered
%# --- Image placement syntax varies based on size
%% macro image(im, size='h')
%% if ('skip_action_photos' in im.book.format_options) and (im.ref == 'pt') and ('force_include' not in im.format_options)
%# --- bad form, but its early and I couldn't figure out how to do this without using else
%% else
%% if size == 'f' or size == 'h'
	%% if size == 'f'
	\end{multicols}
	%% endif
	\setbox0=\hbox{\begin{overpic}[width=0.8\linewidth]{\VAR{im.path_o+im.outFileName}}\VAR{caption1(im.latex_description)}
	\end{overpic}}
	\needspace{\ht0}
	\begin{center}
	\begin{overpic}[width=0.9\linewidth]{\VAR{im.path_o+im.outFileName}}\VAR{caption1(im.latex_description)}\label{\VAR{im.ref}:\VAR{im.name}}
	\end{overpic}
	\end{center}
	%% if size == 'f'
	\raggedcolumns
	\begin{multicols}{2}
	%% endif
%% elif size == 'p'
	\includepdf[picturecommand*={\label{\VAR{im.ref}:\VAR{im.name}}\VAR{caption2(im.latex_description)}}]{\VAR{im.path_o+im.outFileName}}
%% elif size == 's'
	\cleartoleftpage
	\includepdf[pages=-, picturecommand*={\label{\VAR{im.ref}:\VAR{im.name}}\VAR{caption2(im.latex_description)}}]{\VAR{im.path_o+im.outFileName}}
%% endif
%% endif
%% endmacro
%#
%#
%# --- Handles caption placement for half width (h) and full width (f) images. 
%% macro caption1(description)
%% if description
\put (0,5) {\colorbox{\chapterColor}{\parbox{0.7\linewidth}{\textcolor{white}{\VAR{description}}}}}
%% endif
%% endmacro
%#
%# --- Handles caption placement for page (p) and spread (s) images. 
%% macro caption2(description)
%% if description
\put (10,10) {\colorbox{\chapterColor}{\parbox{0.6\paperwidth}{\textcolor{white}{\VAR{description}}}}}
%% endif
%% endmacro
%#
%#
%# --- Places a formatted title and description for the input climb. 
%% macro climbLabel(climb)
\needspace{2em}
\label{\VAR{climb.ref}:\VAR{climb.name}}
\colorbox{\VAR{climb.color_LaTeX}}{
\parbox{0.95\linewidth}{
\hspace{-1ex}\textbf{$\Box$
\VAR{climb.getRtNum()} \VAR{climb.name}\VAR{climb.name_unconfirmed_LaTeX} \VAR{climb.grade_str}\VAR{climb.grade_unconfirmed_LaTeX} \VAR{climb.rating_LaTeX} \VAR{climb.serious_LaTeX}
}}}
\begin{adjustwidth}{1.3em}{}			
\VAR{gps(climb)}
\VAR{climb.description}
%% if not climb.hasTopo
  (No Topo)
%% endif
\end{adjustwidth}
%% endmacro
%#
%#
%# --- Places a description followed by a linebreak so long as description is not empty
%% macro description(description)
%% if description != ''
\VAR{description}\\
%% endif
%% endmacro
%#
%#
%# --- Checks if item has an associated gps qr code and places it if so
%% macro gps(item)
%% if item.gps and ('suppress_gps' not in item.format_options)
\qrcode{\VAR{item.paths['qr_o']}/\VAR{item.item_id}_qr.png}{http://maps.google.com/maps?q=\VAR{item.gps}}{Navigate to this \VAR{item.class_name}}
%% endif
%% endmacro
%#
%# ---------------------------------
%# ------------Body-----------------
%# ---------------------------------
%#
\formatChapter{\VAR{area.name}}
\VAR{resolve_images_area_head(area, size='f')}
\raggedcolumns
\begin{multicols}{2}
\VAR{gps(area)}
%% if area.routes.values() and ('suppress_histogram' not in area.format_options)
\includegraphics[width=\linewidth]{\VAR{area.paths['histogram_o']}/\VAR{area.name}.png}
\end{multicols}
\begin{multicols}{2}
%% endif
\VAR{resolve_images_area_head(area, size='h')}
\VAR{description(area.description)}
%% if area.incomplete
\textbf{NOTE: This area is mostly incomplete. Look forward to more information in future revisions of this book or contribute your own knowledge on github.}\\
%% endif
\VAR{resolve_images(area, 'a')}

%% for subArea in area.subareas.values()
%% if 'suppress_page_break' not in subArea.format_options
\newpage
%% else
\needspace{6em}
%% endif
\VAR{resolve_images(subArea)}
%% if subArea.name
\section{\VAR{subArea.getSubAreaLtr()} - \VAR{subArea.name}}\label{sa:\VAR{subArea.name}}
%% endif
\VAR{gps(subArea)}
\VAR{description(subArea.description)}
\VAR{resolve_images(subArea, 'a')}

%% for formation in subArea.formations.values()
\VAR{resolve_images(formation)}
\needspace{3em}
\subsection*{\VAR{formation.name}}\label{bf:\VAR{formation.name}}
\VAR{gps(formation)}
\VAR{description(formation.description)}
\VAR{resolve_images(formation, 'a')}
%% for route in formation.routes.values()
\VAR{resolve_images(route)}
\VAR{climbLabel(route)}
\VAR{resolve_images(route, 'a')}
%% if route.variations.values()
\begin{adjustwidth}{0.5cm}{}				
\needspace{4em}
\textbf{Variations:} \newline
%% for variation in route.variations.values()
\VAR{resolve_images(variation)}
\VAR{climbLabel(variation)}
\VAR{resolve_images(variation, 'a')}
\VAR{resolve_images(variation, 'e')}
%% endfor
\end{adjustwidth}
%% endif
\VAR{resolve_images(route, 'e')}
%% endfor 
\VAR{resolve_images(formation, 'e')}
%% endfor 
\VAR{resolve_images(subArea, 'e')}
%% endfor
\VAR{resolve_images(area, 'e')}
\end{multicols}
\clearpage